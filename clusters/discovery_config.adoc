[#discovery-config]
= Enable Discovery using the CLI

Enable discovery using the CLI to find clusters that are available from Red Hat OpenShift Cluster Manager (link).

[#enable-prerequisites]
== Prerequisites

* Create a credential to connect to Red Hat OpenShift Cluster Manager.

[#setup-discovery]
== Discovery set up and process

*Note:* The `DiscoveryConfig` must be named `discoveryconfig`. See the following simple `DiscoveryConfig` sample:

[source,yaml]
----
apiVersion: discovery.open-cluster-management.io/v1
kind: DiscoveryConfig
metadata:
  name: discoveryconfig
spec:
  providerConnections:
    - <SECRET_NAME>
  filters:
    age: 7
----

. Replace `SECRET_NAME` with the provider connection that you previously set up
. Enter the maximum age of your cluster (in days) to discover. For example, `age: 7` means only clusters created in the last 7 days are discovered.

[#refresh-discovery]
=== DiscoveredClusterRefresh

The `DiscoveredClusterRefresh` object initiates the controller reconcile. After the reconcile completes, the controller deletes the `DiscoveredClusterRefresh` object with the `discoveredclusterrefreshes.discovery.open-cluster-management.io` API.

See the following sample of `DiscoveredClusterRefresh` in Operator Lifecycle Manager:

[source,yaml]
----
apiVersion: discovery.open-cluster-management.io/v1
kind: DiscoveredClusterRefresh
metadata:
  name: discoveredclusterrefresh-sample
spec: {}
----

[#discovered-clusters]
=== DiscoveredClusters

These objects are created by the Discovery controller. These `DiscoveredClusters` represent the clusters that are found in OCM by using the filters and credentials that are specified in the `DiscoveryConfig` `discoveredclusters.discovery.open-cluster-management.io` API.

The majority of the data in the DiscoveredCluster object comes from the Operator Lifecycle Manager. See the following sample:

[source,yaml]
----
apiVersion: discovery.open-cluster-management.io/v1
kind: DiscoveredCluster
metadata:
  creationTimestamp: "2020-11-17T15:37:30Z"
  generation: 1
  name: 1grosagqroo9annieibm0p53bs5vk5gq
  namespace: open-cluster-management
  resourceVersion: "70225271"
  selfLink: /apis/discovery.open-cluster-management.io/v1/namespaces/open-cluster-management/discoveredclusters/1grosagqroo9annieibm0p53bs5vk5gq
  uid: 27315859-62a8-4ef1-b8d5-110cdd5978cd
spec:
  activity_timestamp: "2020-11-10T02:04:51Z"
  cloudProvider: azure
  console: https://console-openshift-console.apps.console-ui-test-cluster-azure-199490211.az.red-chesterfield.com
  creation_timestamp: "2020-11-10T00:17:46Z"
  healthState: healthy
  name: 9e7d6585-8470-4ea6-9ce0-584f661506a1
  openshiftVersion: 4.3.40
  product: ocp
  providerConnections:
  - apiVersion: v1
    kind: Secret
    name: ocm-api-token
    namespace: open-cluster-management
    resourceVersion: "56338771"
    uid: 9f73592e-39f1-4f4e-bc89-44f4a3fd3053
  state: ready
  subscription:
    creator_id: abc123
    managed: false
    status: Active
    support_level: None
    ----
