[#install-on-disconnected-networks]
= Install on disconnected networks

You might need to install the {mce-short} on {ocp} clusters that are not connected to the Internet. The procedure to install on a disconnected engine requires some of the same steps as the connected installation.

*Important:* You must install {mce-short} on a cluster that does not have Red Hat Advanced Cluster Management for Kubernetes earlier than 2.5 installed. The {mce-short} cannot co-exist with Red Hat Advanced Cluster Management for Kubernetes on versions earlier than 2.5 because they provide some of the same management components. It is recommended that you install {mce-short} on a cluster that has never previously installed Red Hat Advanced Cluster Management. If you are using Red Hat Advanced Cluster Management for Kubernetes at version 2.5.0 or later then {mce-short} is already installed on the cluster with it.

You must download copies of the packages to access them during the installation, rather than accessing them directly from the network during the installation.

* <<disconnect-prerequisites,Prerequisites>>
* <<confirm-ocp-installation-2,Confirm your OpenShift Container Platform installation>>
* <<installing-in-a-disconnected-environment,Installing in a disconnected environment>>

[#disconnect-prerequisites]
== Prerequisites 

You must meet the following requirements before you install The {mce-short}:

* {ocp} version 4.8 or later must be deployed in your environment, and you must be logged in with the command line interface (CLI). 

* You need access to link:https://catalog.redhat.com/software/containers/search?p=1&application_categories_list=Container%20Platform%20%2F%20Management[catalog.redhat.com].
+
*Note:* For managing bare metal clusters, you must have OpenShift Container Platform version 4.8 or later.
+
See the link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.10/html/installing/index[OpenShift Container Platform version 4.10], link:https://docs.openshift.com/container-platform/4.8/welcome/index.html[OpenShift Container Platform version 4.8].

* Your {ocp} CLI must be version 4.8 or later, and configured to run `oc` commands. See link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.8/html/cli_tools/openshift-cli-oc#cli-getting-started[Getting started with the CLI] for information about installing and configuring the Red Hat OpenShift CLI.
* Your {ocp} permissions must allow you to create a namespace.
* You must have a workstation with Internet connection to download the dependencies for the operator.

[#confirm-ocp-installation-2]
== Confirm your OpenShift Container Platform installation

* You must have a supported OpenShift Container Platform version, including the registry and storage services, installed and working in your cluster. For information about OpenShift Container Platform version 4.8, see link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.8/[OpenShift Container Platform documentation].

* When and if you are connected, you can ensure that the OpenShift Container Platform cluster is set up correctly by accessing the OpenShift Container Platform web console with the following command:

+
----
kubectl -n openshift-console get route console
----
+
See the following example output:
+
----
console console-openshift-console.apps.new-coral.purple-chesterfield.com               
console   https   reencrypt/Redirect     None
----

+
The console URL in this example is: `https:// console-openshift-console.apps.new-coral.purple-chesterfield.com`.
Open the URL in your browser and check the result.

+
If the console URL displays `console-openshift-console.router.default.svc.cluster.local`, set the value for `openshift_master_default_subdomain` when you install OpenShift Container Platform.

[#installing-in-a-disconnected-environment]
== Installing in a disconnected environment

*Important:* You need to download the required images to a mirroring registry to install the operators in a disconnected environment. Without the download, you might receive `ImagePullBackOff` errors during your deployment.

Follow these steps to install the {mce-short} in a disconnected environment:

. Create a mirror registry. If you do not already have a mirror registry, create one by completing the procedure in the link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html/installing/disconnected-installation-mirroring[Disconnected installation mirroring] topic of the {ocp-short} documentation.

+
If you already have a mirror registry, you can configure and use your existing one.

. *Note:* For bare metal only, you need to provide the certificate information for the disconnected registry in your `install-config.yaml` file. To access the image in a protected disconnected registry, you must provide the certificate information so the {mce-short} can access the registry.

.. Copy the certificate information from the registry.
.. Open the `install-config.yaml` file in an editor.
.. Find the entry for `additionalTrustBundle: |`.
.. Add the certificate information after the `additionalTrustBundle` line. The resulting content should look similar to the following example:

+
[source,yaml]
----
additionalTrustBundle: |
  -----BEGIN CERTIFICATE-----
  certificate_content
  -----END CERTIFICATE-----
sshKey: >-
----

+ 
. *Important:* Additional mirrors for disconnected image registries are needed if the following Governance policies are required:

- Container Security Operator policy: Locate the images in the `registry.redhat.io/quay` source.

- Compliance Operator policy: Locate the images in the `registry.redhat.io/compliance` source.

- Gatekeeper Operator policy: Locate the images in the `registry.redhat.io/rhacm2` source.
+
See the following example of mirrors lists for all three operators:

+
[source,yaml]
----
    - mirrors:
      - <your_registry>/rhacm2
      source: registry.redhat.io/rhacm2
    - mirrors:
      - <your_registry>/quay
      source: registry.redhat.io/quay
    - mirrors:
      - <your_registry>/compliance
      source: registry.redhat.io/compliance
----

. Save the `install-config.yaml` file.

. Create a YAML file that contains the `ImageContentSourcePolicy` with the name `mce-policy.yaml`. *Note:* If you modify this on a running cluster, it causes a rolling restart of all nodes.
+
[source,yaml]
----
apiVersion: operator.openshift.io/v1alpha1
kind: ImageContentSourcePolicy
metadata:
  name: mce-repo
spec:
  repositoryDigestMirrors:
  - mirrors:
    - mirror.registry.com:5000/multicluster-engine
    source: registry.redhat.io/multicluster-engine
----

. Apply the ImageContentSourcePolicy file by entering the following command:
+
----
oc apply -f mce-policy.yaml
----

. Enable the disconnected Operator Lifecycle Manager Red Hat Operators and Community Operators.
+
the {mce-short} is included in the Operator Lifecycle Manager Red Hat Operator catalog.

. Configure the disconnected Operator Lifecycle Manager for the Red Hat Operator catalog. Follow the steps in the link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html/operators/administrator-tasks#olm-restricted-networks[Using Operator Lifecycle Manager on restricted networks] topic of the {ocp} documentation.

. Now that you have the image in the disconnected Operator Lifecycle Manager, continue to install the {mce-short} for Kubernetes from the  Operator Lifecycle Manager catalog.

See xref:./install_connected.adoc#installing-while-connected-online-mce[Installing while connected online] for the required steps.

[#mirror-ironic-agent-image-mce]
== Mirroring images when using Assisted Installer

If you deploy managed clusters by using `assisted-service`, the {ocp} image is not mirrored automatically in disconnected environments. You must use a matching {ocp-short} ironic agent image to install managed clusters. The hub cluster {ocp-short} version determines which ironic agent image to use. In a disconnected environment, you must mirror the {ocp-short} image manually.

[#mirror-ironic-agent-image-mce-matching]
=== Mirroring images manually on matching CPU architectures

If your hub cluster and managed clusters use the same CPU architecture, complete the following steps to mirror the ironic agent image manually:

. Run the following command to find the matching ironic agent image version. Replace `<hub-release-image>` with the image for the hub cluster release:
+
----
oc adm release info --image-for=ironic-agent <hub-release-image>
----

. Run the following command to mirror the ironic agent image:
+
----
skopeo copy <image-from-oc-adm-output> <mirror>
----
+
Replace `<image-from-oc-adm-output>` with the image from the output of step 1.
+
Replace `<mirror>` with your mirrored image.

[#mirror-ironic-agent-image-mce-different]
=== Mirroring images manually on different CPU architectures

If your hub cluster and managed clusters use different CPU architectures, a default ironic agent image is used. Complete the following steps to mirror the correct default ironic agent image manually:

. If you are running an arm64 CPU on the hub cluster and a x86_64 CPU on your managed cluster, use the following image: `quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:d3f1d4d3cd5fbcf1b9249dd71d01be4b901d337fdc5f8f66569eb71df4d9d446`

. If you are running a x86_64 CPU on the hub cluster and an arm64 CPU on your managed cluster, use the following image: `quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:cb0edf19fffc17f542a7efae76939b1e9757dc75782d4727fb0aa77ed5809b43`

. Run the following command to mirror the ironic agent image:
+
----
skopeo copy <default-image> <mirror>
----
+
Replace `<default-image>` with the image from step 1 or step 2, depending on your combination of CPU architectures.
+
Replace `<mirror>` with your mirrored image.
