[#backup-restore-enable]
= Enable the backup and restore operator

Enable the the Backup and Restore Operator to schedule back up and restore for your cluster resources. {product-title} offers the cluster backup operator as a Technology preview that is disabled by default.

**Required access**: Cluster administrator 

[#prereq-backup-restore-enable]
== Prerequisites

. Install the link:https://github.com/openshift/oadp-operator[OADP Operator], which installs link:https://velero.io/[Velero].
+
*Note*: Be sure to follow the OADP Operator installation instructions to create the Velero resource, and to create a valid connection to a backup storage location, where the backups are stored. View the installation and setup steps from the link:https://github.com/openshift/oadp-operator#installing-operator[oadp-operator repository].

[#enabling-backup-restore]
== Enabling the backup and restore operator

Enable the cluster backup and restore operator by creating the `MultiClusterHub` resource and update the `enableClusterBackup` parameter to `true`.

If the `MultiClusterHub` resource is already created, you can disable the cluster backup YAML by editing the `MultiClusterHub` resource. Set `enableClusterBackup` to `false`.

When the backup and restore operator is enabled, your `MultiClusterHub` resource might resemble the following YAML file:

[source,yaml]
----
apiVersion: operator.open-cluster-management.io/v1
  kind: MultiClusterHub
  metadata:
    name: multiclusterhub
    namespace: open-cluster-management
  spec:
    availabilityConfig: High
    enableClusterBackup: true <-----
    imagePullSecret: multiclusterhub-operator-pull-secret
    ingress:
      sslCiphers:
      - ECDHE-ECDSA-AES256-GCM-SHA384
      - ECDHE-RSA-AES256-GCM-SHA384
      - ECDHE-ECDSA-AES128-GCM-SHA256
      - ECDHE-RSA-AES128-GCM-SHA256
    separateCertificateManagement: false
----

[#using-backup-restore]
== Using the backup and restore operator

Complete the following steps to schedule and restore backups:

. Create a `backupschedule.cluster.open-cluster-management.io` resource to schedule data backups. The resource is configured to create all of the necessary intermediary schedule backup resources. Run the following command. Be sure to replace the `<oadp-operator-ns>` with the namespace name used to install the OADP Operator (the default value for the OADP Operator install namespace is `oadp-operator`):
+
----
kubectl create -n <oadp-operator-ns> -f config/samples/cluster_v1beta1_backupschedule.yaml
----
+
Your resource might resemble the following file:
+
[source,yaml]
----
apiVersion: cluster.open-cluster-management.io/v1beta1
kind: BackupSchedule
metadata:
  name: schedule-acm
spec:
  maxBackups: 10 # maximum number of backups after which old backups should be removed
  veleroSchedule: 0 */6 * * * # Create a backup every 6 hours
  veleroTtl: 72h # deletes scheduled backups after 72h; optional, if not specified, the maximum default value set by velero is used - 720h
----
+
View the following descriptions of the following properties:
+
** `maxBackup` is a required property and represents the maximum number of backups after previous backups are removed.
** `veleroSchedule` is a required property and defines a cron job for scheduling the backups.
** `veleroTtl` is an optional property and defines the expiration time for a scheduled backup resource. If not specified, the maximum default value set by Velero is used, which is `720h`.

. Check the status of your scheduled cluster backups, which displays the definition for the three `schedule.velero.io` resources. Run the following command:
+
----
oc get bsch -n <oadp-operator-ns>
----

. Create a `restore.cluster.open-cluster-management.io` resource on a different hub cluster to restore a backup. The resource restores the backup and runs any other post to restore operations, such as registering restored remote clusters with the new hub cluster. Run the following command. Run the following command. Be sure to replace the `<oadp-operator-ns>` with the namespace name used to install the OADP Operator (the default value for the OADP Operator install namespace is `oadp-operator`):
+
Your resource might resemble the following file:
+
[source,yaml]
----
apiVersion: cluster.open-cluster-management.io/v1beta1
kind: Restore
metadata:
  name: restore-acm
spec:
  veleroManagedClustersBackupName: latest
  veleroCredentialsBackupName: latest
  veleroResourcesBackupName: latest
----
+
View the following description of the following property:
+
** The `backupName` represents the name of the `backup.velero.io` resource to be restored on the hub cluster, where the `restore.cluster.open-cluster-management.io` resource is created.

. View the Velero `Restore` resource by running the following command:
+
----
oc get restore.velero.io -n <oadp-operator-ns>
----
+
View the following YAML examples to restore different types of backed up files:
+
** Restore all three types of backed up files:
+
[source,yaml]
----
apiVersion: cluster.open-cluster-management.io/v1beta1
kind: Restore
metadata:
  name: restore-acm
spec:
  veleroManagedClustersBackupName: latest
  veleroCredentialsBackupName: latest
  veleroResourcesBackupName: latest
----
+
** Restore only managed cluster:
+
[source,yaml]
----
apiVersion: cluster.open-cluster-management.io/v1beta1
kind: Restore
metadata:
  name: restore-acm
spec:
  veleroManagedClustersBackupName: latest
  veleroCredentialsBackupName: skip
  veleroResourcesBackupName: skip
----
+
** Restore the resources for managed clusters only, using the `acm-managed-clusters-schedule-20210902205438` backup:
+
[source,yaml]
----
apiVersion: cluster.open-cluster-management.io/v1beta1
kind: Restore
metadata:
  name: restore-acm
spec:
  veleroManagedClustersBackupName: acm-managed-clusters-schedule-20210902205438
  veleroCredentialsBackupName: skip
  veleroResourcesBackupName: skip
----

See xref:../clusters/backup_and_restore.adoc#restore-backup[Restore a backup] for a description of the required specification properties and the valid options. *Note*: The `restore.cluster.open-cluster-management.io` resource is run once. After the restore operation is completed, you can optionally run another restore operation on the same hub cluster. You must create a new `restore.cluster.open-cluster-management.io` resource to run a new restore operation.

