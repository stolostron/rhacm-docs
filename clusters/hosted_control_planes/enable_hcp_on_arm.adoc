[#hosted-cluster-arm-aws]
= Enabling hosted control planes on an ARM64 {ocp-short} cluster (Technology Preview)

You can enable an ARM64 hosted control plane to operate with an {ocp-short} ARM64 data plane in a management cluster.

[#prerequisites-hosted-arm]
== Prerequisites

* You must have an {ocp-short} cluster with a 64-bit ARM infrastructure that is installed on Amazon Web Serivces (AWS). For more information, see link:https://console.redhat.com/openshift/install/aws/arm[Create an OpenShift Cluster: AWS (ARM)].
* You must create an AWS Identity and Access Management (IAM) role and AWS Security Token Service (STS) credentials. See xref:../../clusters/hosted_control_planes/create_role_sts_aws.adoc#create-role-sts-aws[Creating an AWS IAM role and STS credentials].

[#hosted-cluster-arm64]
== Running a hosted cluster on an ARM64 {ocp-short} cluster

You can run a hosted cluster on an ARM64 {ocp-short} cluster by overriding the default release image with a multi-architecture release image. Complete the following steps:

. Create a hosted cluster by running the following command:

+
[source,bash]
----
hcp create cluster aws \
--name <hosted_cluster_name> \ <1>
--node-pool-replicas <node_pool_replica_count> \ <2>
--base-domain <basedomain> \ <3>
--pull-secret <path_to_pull_secret> \ <4>
--sts-creds <path_to_sts_credential_file> \ <5>
--region <region> \ <6>
--release-image quay.io/openshift-release-dev/ocp-release:<ocp_release_image> <7>
--role-arn <role_name> <8>
----

+
<1> Specify the name of your hosted cluster, for instance, `example`.
<2> Specify the node pool replica count, for example, `3`.
<3> Specify your base domain, for example, `example.com`.
<4> Specify the path to your pull secret, for example, `/user/name/pullsecret`.
<5> Specify the path to your AWS STS credentials file, for example, `/home/user/sts-creds/sts-creds.json`.
<6> Specify the AWS region name, for example, `us-east-1`.
<7> Specify the supported {ocp-short} version that you want to use, for example, `4.14.0-x86_64`. If you are using a disconnected environment, replace `<ocp_release_image>` with the digest image. To extract the {ocp-short} release image digest, see _Extracting the {ocp-short} release image digest_.
<8> Specify the Amazon Resource Name (ARN), for example, `arn:aws:iam::820196288204:role/myrole`.

. Add a 64-bit x_86 `NodePool` object to the hosted cluster by running the following command:

+
[source,bash]
----
hcp create nodepool aws \
--cluster-name <hosted_cluster_name> \ <1>
--name <nodepool_name> \ <2>
--node-count <node_pool_replica_count> <3>
----

+
<1> Specify the name of your hosted cluster, for instance, `example`.
<2> Specify the node pool name.
<3> Specify the node pool replica count, for example, `3`.


[#hosted-cluster-arm-node-pools]
== Creating ARM NodePool objects on AWS hosted clusters

You can schedule application workloads (`NodePool` objects) on 64-bit ARM and AMD64 from the same hosted control plane. You can define the `arch` field in the `NodePool` specification to set the required processor architecture for the `NodePool` object. The valid values for the `arch` field are as follows:

* `arm64`
* `amd64`

If you do not specify a value for the `arch` field, the `amd64` value is used by default.

To create an ARM `NodePool` object on a hosted cluster on AWS, complete the following steps:

. To render the `NodePool` object configuration in a YAML format, run the following command:

+
[source,bash]
----
hcp create nodepool aws \
cluster-name <hosted_cluster_name> \ <1>
--name <arm64_node_pool_name> \ <2>
--node-count <node_pool_replica_count> \ <3>
--render > arm64-nodepool.yml <4>
----

+
<1> Specify the name of your hosted cluster, for instance, `example`.
<2> Specify the node pool name.
<3> Specify the node pool replica count, for example, `3`.
<4> The `NodePool` object configuration is saved in the `arm64-nodepool.yml` file.

+
The command creates a YAML file that specifies the CPU architecture for the `NodePool` object, as shown in the following example:

+
[source,yaml]
----
apiVersion: hypershift.openshift.io/v1beta1
kind: NodePool
metadata:
  creationTimestamp: null
  name: hypershift-arm-us-east-1a
  namespace: clusters
spec:
  arch: amd64
  clusterName: hypershift-arm
  management:
    autoRepair: false
    upgradeType: Replace
  nodeDrainTimeout: 0s
  platform:
    aws:
      instanceProfile: hypershift-arm-2m289-worker
      instanceType: m5.large
      rootVolume:
        size: 120
        type: gp3
      securityGroups:
      - id: sg-064ea63968d258493
      subnet:
        id: subnet-02c74cf1cf1e7413f
    type: AWS
  release:
    image: quay.io/openshift-release-dev/ocp-release-nightly@sha256:390a33cebc940912a201a35ca03927ae5b058fbdae9626f7f4679786cab4fb1c
  replicas: 3
status:
  replicas: 0
----

. Modify the `arch` and `instanceType` values in the YAML file by entering the following command. In the command, the ARM instance type is `m6g.large`, but any ARM instance type works:

+
----
sed 's/arch: amd64/arch: arm64/g; s/instanceType: m5.large/instanceType: m6g.large/g' arm_nodepool_spec.yml > temp.yml && mv temp.yml arm_nodepool_spec.yml
----

. Apply the rendered YAML file to the hosted cluster by entering the following command:

+
----
oc apply -f arm_nodepool_spec.yml
----

+
//lahinson - sept. 2023 - adding comment to ensure proper formatting
