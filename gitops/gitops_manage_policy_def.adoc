[#gitops-policy-definitions]
= Managing policy definitions with {ocp-short} GitOps (Argo CD)

With Argo CD, you can use {ocp-short} GitOps to manage policy definitions by granting {ocp-short} GitOps access to create policies on the {acm-short} hub cluster. When a {acm-short} policy definition is deployed with {ocp-short} GitOps, a copy of the policy is created in each managed cluster namespace. These copies are called replicated policies.

*Deprecated:* `PlacementRule`

Complete the following steps to create a `ClusterRole` resource for {ocp-short} GitOps, with access to create, read, update, and delete policies and placements:

. Create a `ClusterRole` from the console. Your `ClusterRole` might resemble the following example:

+
[source,yaml]
----
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: openshift-gitops-policy-admin
rules:
  - verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
    apiGroups:
      - policy.open-cluster-management.io
    resources:
      - policies
      - policysets
      - placementbindings
  - verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
    apiGroups:
      - apps.open-cluster-management.io
    resources:
      - placementrules
  - verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
    apiGroups:
      - cluster.open-cluster-management.io
    resources:
      - placements
      - placements/status
      - placementdecisions
      - placementdecisions/status
----

. Create a `ClusterRoleBinding` object to grant the {ocp-short} GitOps service account access to the `openshift-gitops-policy-admin` `ClusterRole` object. Your `ClusterRoleBinding` might resemble the following example:

+
[source,yaml]
----
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: openshift-gitops-policy-admin
subjects:
  - kind: ServiceAccount
    name: openshift-gitops-argocd-application-controller
    namespace: openshift-gitops
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: openshift-gitops-policy-admin
----

To prevent {ocp-short} GitOps from repeatedly deleting this replicated policy or show that the ArgoCD `Application` is out of sync, the `argocd.argoproj.io/compare-options: IgnoreExtraneous` annotation is automatically set on each replicated policy by the {acm-short} policy framework.

There are labels and annotations used by Argo CD to track objects. For replicated policies to not show up at all in Argo CD, you can set `spec.copyPolicyMetadata` to `false` on the {acm-short} policy definition to disable the Argo CD tracking labels and annotations from being copied to the replicated policy.

[#policy-gen-install-on-openshift-gitops]
== Integrating the Policy Generator with {ocp-short} GitOps (Argo CD)

Based on Argo CD, you can use {ocp-short} GitOps to generate policies by using the Policy Generator through GitOps. Since the Policy Generator does not come preinstalled in the {ocp-short} GitOps container image, you must complete customizations. You must have the {ocp-short} GitOps Operator installed on the {acm-short} hub cluster and be sure to log in to the hub cluster.

For {ocp-short} GitOps to have access to the Policy Generator when you run Kustomize, an Init Container is required to copy the Policy Generator binary from the {acm-short} Application Subscription container image to the {ocp-short} GitOps container. Additionally, {ocp-short} GitOps must be configured to provide the `--enable-alpha-plugins` flag when it runs Kustomize. Complete the following steps:

. Start editing the {ocp-short} GitOps `argocd` object with the following command:

+
[source,bash]
----
oc -n openshift-gitops edit argocd openshift-gitops
----

. Modify the {ocp-short} GitOps `argocd` object to contain the following additional YAML content. When a new major version of {acm-short} is released and you want to update the Policy Generator to a newer version, you need to update the `registry.redhat.io/rhacm2/multicluster-operators-subscription-rhel9` image used by the Init Container to a newer tag. View the following example and replace `<version>` with {product-version} or your desired {acm-short} version:

+
[source,yaml]
----
apiVersion: argoproj.io/v1beta1
kind: ArgoCD
metadata:
  name: openshift-gitops
  namespace: openshift-gitops
spec:
  kustomizeBuildOptions: --enable-alpha-plugins
  repo:
    env:
    - name: KUSTOMIZE_PLUGIN_HOME
      value: /etc/kustomize/plugin
    initContainers:
    - args:
      - -c
      - cp /policy-generator/PolicyGenerator-not-fips-compliant /policy-generator-tmp/PolicyGenerator
      command:
      - /bin/bash
      image: registry.redhat.io/rhacm2/multicluster-operators-subscription-rhel9:v<version>
      name: policy-generator-install
      volumeMounts:
      - mountPath: /policy-generator-tmp
        name: policy-generator
    volumeMounts:
    - mountPath: /etc/kustomize/plugin/policy.open-cluster-management.io/v1/policygenerator
      name: policy-generator
    volumes:
    - emptyDir: {}
      name: policy-generator
----
+
*Note:* Alternatively, you can create a `ConfigurationPolicy` resource that contains the `ArgoCD` manifest and template the version to match the version set in the `MulticlusterHub`:

+
[source,yaml]
----
image: '{{ (index (lookup "apps/v1" "Deployment" "open-cluster-management" "multicluster-operators-hub-subscription").spec.template.spec.containers 0).image }}'
----
+
If you want to enable the processing of Helm charts inside of a Kustomize directory before generating policies, set the environment variable `POLICY_GEN_ENABLE_HELM` to `"true"` in the `spec.repo.env` field:

+
[source,yaml]
----
env:
- name: POLICY_GEN_ENABLE_HELM
  value: "true"
----

. Now that {ocp-short} GitOps can use the Policy Generator, {ocp-short} GitOps must be granted access to create policies on the {acm-short} hub cluster. Create the `ClusterRole` resource called `openshift-gitops-policy-admin`, with access to create, read, update, and delete policies and placements. Refer to the ealier `ClusterRole` resource example.

. Create a `ClusterRoleBinding` object to grant the {ocp-short} GitOps service account access to the `openshift-gitops-policy-admin` `ClusterRole`. Your `ClusterRoleBinding` might resemble the following resource:

+
[source,yaml]
----
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: openshift-gitops-policy-admin
subjects:
  - kind: ServiceAccount
    name: openshift-gitops-argocd-application-controller
    namespace: openshift-gitops
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: openshift-gitops-policy-admin
----

[#config-gitops-healthcheck]
== Configuring policy health checks in {ocp-short} GitOps (Argo CD)

With Argo CD, you can define custom logic to determine the current health of specific resource based on the resource state. You can define custom health checks to report the policy as healthy only when your policy is compliant. When you add a health check for a resource, you must add it as a `group` in the `resourceHealthChecks` field. Complete the following steps to define health checks for your resource kinds:

. To add the health checks, edit the {ocp-short} GitOps `ArgoCD` resource with the following command:

+
[source,bash]
----
oc -n openshift-gitops edit argocd openshift-gitops
----

. To add a health check to your `CertificatePolicy` resource, download the `argocd-policy-healthchecks.yaml` by running the following command:

+
[source,bash]
----
wget https://raw.githubusercontent.com/open-cluster-management-io/policy-collection/main/stable/CM-Configuration-Management/argocd-policy-healthchecks.yaml
----

. To verify that you did not download something malicious from the Internet, review the policy before you apply it. Your `ArgoCD` resource might resemble the following YAML file:

+
[source,yaml]
----
apiVersion: argoproj.io/v1beta1 
kind: ArgoCD 
metadata: 
	name: openshift-gitops 
	namespace: openshift-gitops 
spec: 
	resourceHealthChecks: 
	    - group: policy.open-cluster-management.io 
	      kind: CertificatePolicy 
	      check: | 
	          hs = {} 
	          if obj.status == nil or obj.status.compliant == nil then
	            hs.status = "Progressing" 
	            hs.message = "Waiting for the status to be reported" 
	            return hs 
	          end 
	          if obj.status.compliant == "Compliant" then 
	            hs.status = "Healthy" hs.message = "All certificates found comply with the policy" 
	            return hs 
	          else hs.status = "Degraded" 
	             hs.message = "At least one certificate does not comply with the policy"
	             return hs 
            end
----

. To apply the `argocd-policy-healthchecks.yaml` policy, run the following command:

+
[source,bash]
----
oc apply -f ./argocd-policy-healthchecks.yaml
----

. Verify that the health checks work as expected by viewing the _Summary_ tab of the `ArgoCD` resource. View the health details from the Argo CD console.

[#additional-resource-policy-def]
== Additional resources

* Refer to link:https://argoproj.github.io/argo-cd/[Argo CD] documentation.


