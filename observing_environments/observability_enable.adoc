[#enable-observability]
= Enable observability service

Monitor the health of your managed clusters with the observability service (`multicluster-observability-operator`).

*Required access:* Cluster administrator or the `open-cluster-management:cluster-manager-admin` role.

* <<prerequisites-observability,Prerequisites>>
* <<enabling-observability,Enabling observability>>
* <<creating-mco-cr,Creating the _MultiClusterObservability_ CR>>
* <<disabling-observability-resource,Disabling observability>>

[#prerequisites-observability]
== Prerequisites
 
- You must install {product-title}. See link:../install/install_connected.adoc#installing-while-connected-online[Installing while connected online] for more information.  
- You must configure an object store to create a storage solution. {product-title-short} supports the following cloud providers with stable object stores:
* https://aws.amazon.com/getting-started/hands-on/lightsail-object-storage/[Amazon Web Services S3 (AWS S3)]
* https://www.redhat.com/en/technologies/storage/ceph[Red Hat Ceph (S3 compatible API)]
* https://cloud.google.com/storage[Google Cloud Storage]
* https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction[Azure storage]
* https://docs.openshift.com/container-platform/4.7/storage/persistent_storage/persistent-storage-ocs.html[Red Hat OpenShift Container Storage]
+
*Important*: When you configure your object store, ensure that you meet the encryption requirements necessary when sensitive data is persisted. For more information on Thanos supported object stores, see https://thanos.io/tip/thanos/storage.md/#object-storage[Thanos documentation].

[#enabling-observability]
== Enabling observability

Enable the observability service by creating a `MultiClusterObservability` custom resource (CR) instance. Before you enable observability, see xref:../observing_environments/observe_environments.adoc#observability-pod-capacity-requests[Observability pod capacity requests] for more information. Complete the following steps to enable the observability service: 

. Log in to your {product-title-short} hub cluster. 
. Create a namespace for the observability service with the following command:
+
----
oc create namespace open-cluster-management-observability
----

. Generate your pull-secret. If {product-title-short} is installed in the `open-cluster-management` namespace, run the following command:
 
+
----
DOCKER_CONFIG_JSON=`oc extract secret/multiclusterhub-operator-pull-secret -n open-cluster-management --to=-`
----
+
If the `multiclusterhub-operator-pull-secret` is not defined in the namespace, copy the `pull-secret` from the `openshift-config` namespace into the `open-cluster-management-observability` namespace. Run the following command:
+
----
DOCKER_CONFIG_JSON=`oc extract secret/pull-secret -n openshift-config --to=-`
----
+
Then, create the pull-secret in the `open-cluster-management-observability` namespace, run the following command:
+
----
oc create secret generic multiclusterhub-operator-pull-secret \
    -n open-cluster-management-observability \
    --from-literal=.dockerconfigjson="$DOCKER_CONFIG_JSON" \
    --type=kubernetes.io/dockerconfigjson
----

. Create a secret for your object storage for your cloud provider. Your secret must contain the credentials to your storage solution. For example, run the following command:

+
----
oc create -f thanos-object-storage.yaml -n open-cluster-management-observability
----
+
.. View the following examples of secrets for the supported object stores:
*** For {product-title-short}, your secret might resemble the following file:
+
----
apiVersion: v1
kind: Secret
metadata:
  name: thanos-object-storage
  namespace: open-cluster-management-observability
type: Opaque
stringData:
  thanos.yaml: |
    type: s3
    config:
      bucket: YOUR_S3_BUCKET
      endpoint: YOUR_S3_ENDPOINT
      insecure: true
      access_key: YOUR_ACCESS_KEY
      secret_key: YOUR_SECRET_KEY
----

*** For Amazon S3 or S3 compatible, your secret might resemble the following file:
+
----
apiVersion: v1
kind: Secret
metadata:
  name: thanos-object-storage
  namespace: open-cluster-management-observability
type: Opaque
stringData:
  thanos.yaml: |
    type: s3
    config:
      bucket: YOUR_S3_BUCKET
      endpoint: YOUR_S3_ENDPOINT
      insecure: true
      access_key: YOUR_ACCESS_KEY
      secret_key: YOUR_SECRET_KEY
----
+
For more details, see https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html[Amazon Simple Storage Service user guide].

*** For Google, your secret might resemble the following file: 
+
----
apiVersion: v1
kind: Secret
metadata:
  name: thanos-object-storage
  namespace: open-cluster-management-observability
type: Opaque
stringData:
  thanos.yaml: |
    type: GCS
    config:
      bucket: YOUR_GCS_BUCKET
      service_account: YOUR_SERVICE_ACCOUNT
----
+
For more details, see https://cloud.google.com/storage/docs/introduction[Google Cloud Storage].

*** For Azure your secret might resemble the following file:
+
----
apiVersion: v1
kind: Secret
metadata:
  name: thanos-object-storage
  namespace: open-cluster-management-observability
type: Opaque
stringData:
  thanos.yaml: |
    type: AZURE
    config:
      storage_account: YOUR_STORAGE_ACCT
      storage_account_key: YOUR_STORAGE_KEY
      container: YOUR_CONTAINER
      endpoint: blob.core.windows.net
      max_retries: 0
----
+
For more details, see https://docs.microsoft.com/en-us/azure/storage/[Azure Storage documentation].

*** For OpenShift Container Storage, your secret might resemble the following file:
+
----
apiVersion: v1
kind: Secret
metadata:
  name: thanos-object-storage
  namespace: open-cluster-management-observability
type: Opaque
stringData:
  thanos.yaml: |
    type: s3
    config:
      bucket: YOUR_OCS_BUCKET
      endpoint: YOUR_OCS_ENDPOINT
      insecure: true
      access_key: YOUR_OCS_ACCESS_KEY
      secret_key: YOUR_OCS_SECRET_KEY
----
+
For more details, see https://access.redhat.com/documentation/en-us/red_hat_openshift_container_storage/4.6/html/deploying_openshift_container_storage/deploying-openshift-container-storage-on-openshift-container-platform_rhocs#installing-openshift-container-storage-operator-using-the-operator-hub_aws-vmware[Installing OpenShift Container Storage].

.. You can retrieve the S3 access key and secret key for your cloud providers with the following commands:
+
----
ACCESS_KEY=$(oc -n <your-object-storage> get secret <object-storage-secret> -o yaml | grep AccessKey | awk '{print $2}' | base64 --decode)

echo $ACCESS_KEY

SECRET_KEY=$(oc -n <your-object-storage> get secret <object-storage-secret> -o yaml | grep SecretKey | awk '{print $2}' | base64 --decode)

echo $SECRET_KEY
----

[#creating-mco-cr]
=== Creating the _MultiClusterObservability_ CR

Complete the following steps to create the `MultiClusterObservability` custom resource (CR):

. Create the `MultiClusterObservability` custom resource (mco CR) for your managed cluster by completing the following steps:
+
.. Create the `MultiClusterObservability` custom resource YAML file named `_multiclusterobservability_cr.yaml_`. 
+
View the following default YAML file for observability:
+
----
apiVersion: observability.open-cluster-management.io/v1beta1
kind: MultiClusterObservability
metadata:
  name: observability #Your customized name of MulticlusterObservability CR
spec:
  availabilityConfig: High # Available values are High or Basic
  enableDownSampling: false # The default value is false. This is not recommended as querying long-time ranges without non-downsampled data is not efficient and useful.
  imagePullPolicy: Always
  imagePullSecret: multiclusterhub-operator-pull-secret
  observabilityAddonSpec: # The ObservabilityAddonSpec defines the global settings for all managed clusters which have observability add-on enabled
    enableMetrics: true # EnableMetrics indicates the observability addon push metrics to hub server
    interval: 30 # Interval for the observability addon push metrics to hub server
  retentionResolution1h: 30d # How long to retain samples of 1 hour in bucket
  retentionResolution5m: 14d
  retentionResolutionRaw: 5d
  storageConfigObject: # Specifies the storage to be used by Observability
    metricObjectStorage:
      name: thanos-object-storage
      key: thanos.yaml
    statefulSetSize: 10Gi # The amount of storage applied to the Observability StatefulSets, i.e. Amazon S3 store, Rule, compact and receiver.
    statefulSetStorageClass: gp2
----
+
You might want to modify the value for the `retentionResolution` parameter. By default, downsampling is disabled. For more information, see https://thanos.io/v0.8/components/compact/#downsampling-resolution-and-retention[Thanos Downsampling resolution and retention]. Depending on the number of managed clusters, you might want to update `statefulSetSize`, see link:../apis/observability.json.adoc#observability-api[Observability API] for more information.
+
.. To deploy on infrastructure machine sets, you must set a label for your set by updating the `_nodeSelector_` in the `MultiClusterObservability` YAML. Your YAML might resemble the following content:
+
----
nodeSelector:
    node-role.kubernetes.io/infra: 
----
+
For more information, see https://docs.openshift.com/container-platform/4.6/machine_management/creating-infrastructure-machinesets.html[Creating infrastructure machine sets].

.. Apply the observability YAML to your cluster by running the following command:
+
----
oc apply -f multiclusterobservability_cr.yaml
----
+
All the pods in `open-cluster-management-observability` namespace for Thanos, Grafana and AlertManager are created. All the managed clusters connected to the {product-title-short} hub cluster are enabled to send metrics back to the {product-title-short} Observability service.

. To validate that the observability service is enabled, launch the Grafana dashboards to make sure the data is populated. Complete the following steps:
.. Log in to the {product-title-short} console.
.. From the navigation menu, select *Observe environments* > *Overview*.
.. Click the Grafana link that is near the console header to view the metrics from your managed clusters.

[#disabling-observability-resource]
== Disabling observability

To disable the observability service, uninstall the `observability` resource. See step 1 of link:../install/installing#removing-a-multiclusterhub-instance-by-using-commands[Removing a MultiClusterHub instance by using commands] for the procedure.

To learn more about customizing the observability service, see xref:../observing_environments/customize_observability.adoc#customizing-observability[Customizing observability].
