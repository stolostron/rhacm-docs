[#gatekeeper-policy-integration]
= Gatekeeper policy integration

Learn to create, apply, view, and update your gatekeeper policies.

*Required access*: Cluster administrator

*Prerequisite*: You must install Gatekeeper. For more information see https://github.com/open-policy-agent/gatekeeper[`open-policy-agent/gatekeeper`] repository.

[#creating-a-gatekeeper-policy]
== Creating a gatekeeper policy

You can create a YAML file for your gatekeeper policy from the command line interface (CLI). Use the {product-title} configuration policy to propagate the gatekeeper policy from the hub cluster to the managed cluster. View the following sections to create a gatekeeper policy for the admission and auditing scenarios:

[#creating-a-gatekeeper-policy-for-admission]
=== Creating a gatekeeper policy for admission

Use the {product-title-short} configuration policy to create a gatekeeper policy that looks for events that are generated by the gatekeeper admission webhook. 

*Note:* Gatekeeper must be deployed with `emit-admission-events` set to `true`.

. Create a YAML file for your gatekeeper policy.
Run the following command:
+
----
kubectl create -f policy-gatekeeper-admission.yaml
----
+
Your gatekeeper policy might resemble the following policy:

----
apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: policy-gatekeeper
  namespace: default
  annotations:
    policy.open-cluster-management.io/standards: 
    policy.open-cluster-management.io/categories: 
    policy.open-cluster-management.io/controls: 
spec:
  disabled: false
  policy-templates:
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: policy-gatekeeper-k8srequiredlabels
        spec:
          remediationAction: enforce # will be overridden by remediationAction in parent policy
          severity: low
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: templates.gatekeeper.sh/v1beta1
                kind: ConstraintTemplate
                metadata:
                  name: k8srequiredlabels
                spec:
                  crd:
                    spec:
                      names:
                        kind: K8sRequiredLabels
                      validation:
                        # Schema for the `parameters` field
                        openAPIV3Schema:
                          properties:
                            labels:
                              type: array
                              items: string
                  targets:
                    - target: admission.k8s.gatekeeper.sh
                      rego: |
                        package k8srequiredlabels
                        violation[{"msg": msg, "details": {"missing_labels": missing}}] {
                          provided := {label | input.review.object.metadata.labels[label]}
                          required := {label | label := input.parameters.labels[_]}
                          missing := required - provided
                          count(missing) > 0
                          msg := sprintf("you must provide labels: %v", [missing])
                        }
            - complianceType: musthave
              objectDefinition:
                apiVersion: constraints.gatekeeper.sh/v1beta1
                kind: K8sRequiredLabels
                metadata:
                  name: ns-must-have-gk
                spec:
                  match:
                    kinds:
                      - apiGroups: [""]
                        kinds: ["Namespace"]
                  parameters:
                    labels: ["gatekeeper"]
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: policy-gatekeeper-admission
        spec:
          remediationAction: inform # will be overridden by remediationAction in parent policy
          severity: low
          object-templates:
            - complianceType: mustnothave
              objectDefinition:
                apiVersion: v1
                kind: Event
                metadata:
                  namespace: gatekeeper-system
                  annotations:
                    constraint_action: deny
                    constraint_kind: K8sRequiredLabels
                    constraint_name: ns-must-have-gk
                    event_type: violation
             
----        

[#creating-a-gatekeeper-policy-for-audit]
=== Creating a gatekeeper policy for audit

Use the product configuration policy to create a gatekeeper policy that periodically checks and evaluates existing resources against the gatekeeper policies. {product-title-short} configuration policy checks for the violations in the status field of the gatekeeper constraint.

. Create a YAML file for your gatekeeper policy.
Run the following command:
+
----
kubectl create -f policy-gatekeeper-audit.yaml
----
+
Your gatekeeper policy might resemble the following policy:

+
----
apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: policy-gatekeeper
  namespace: default
  annotations:
    policy.open-cluster-management.io/standards: 
    policy.open-cluster-management.io/categories: 
    policy.open-cluster-management.io/controls: 
spec:
  disabled: false
  policy-templates:
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: policy-gatekeeper-audit
        spec:
          remediationAction: inform # will be overridden by remediationAction in parent policy
          severity: low
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: constraints.gatekeeper.sh/v1beta1
                kind: K8sRequiredLabels
                metadata:
                  name: ns-must-have-gk
                status:
                  totalViolations: 0
                  violations: []
----

For more information about integrating third-party policies with the product, see xref:../security/third_party_policy.adoc#integrate-third-party-policies[Integrate third-party policies]. 

