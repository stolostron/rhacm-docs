[#managing-gatekeeper-operator-policies]
= Managing gatekeeper operator policies

Use the gatekeeper operator policy to install the gatekeeper operator and gatekeeper on a managed cluster. Learn to create, view, and update your gatekeeper operator policies in the following sections.

*Required access*: Cluster administrator

* <<install-gatekeeper-operator-policy,Installing gatekeeper using a gatekeeper operator policy>>
* <<creating-a-gatekeeper-policy-from-the-console,Creating a gatekeeper policy from the console>>
** <<gatekeeper-operator-sample,Gatekeeper operator CR>>
* <<upgrading-gatekeeper-gatekeeper-operator,Upgrading gatekeeper and the gatekeeper operator>>
* <<updating-gatekeeper-operator-policy,Updating gatekeeper operator policy>>
** <<viewing-gatekeeper-operator-policy-from-the-console,Viewing gatekeeper operator policy from the console>>
** <<disabling-gatekeeper-operator-policy,Disabling gatekeeper operator policy>>
* <<deleting-gatekeeper-operator-policy,Deleting gatekeeper operator policy>>
* <<uninstalling-gatekeeper,Uninstalling gatekeeper policy, gatekeeper, and gatekeeper operator policy>>

[#install-gatekeeper-operator-policy]
== Installing gatekeeper using a gatekeeper operator policy

Use the governance framework to install the gatekeeper operator. Gatekeeper operator is available in the {ocp-short} catalog. See _Adding Operators to a cluster_ in the https://access.redhat.com/documentation/en-us/openshift_container_platform/4.11/html/operators/administrator-tasks#olm-adding-operators-to-a-cluster[{ocp-short} documentation] for more information.

Use the configuration policy controller to install the gatekeeper operator policy. During the install, the operator group and subscription pull the gatekeeper operator to install it in your managed cluster. Then, the gatekeeper operator creates a gatekeeper CR to configure gatekeeper. View the <<gatekeeper-operator-sample,Gatekeeper operator CR>> sample.

Gatekeeper operator policy is monitored by the {product-title-short} configuration policy controller, where `enforce` remediation action is supported. Gatekeeper operator policies are created automatically by the controller when set to `enforce`.

[#creating-a-gatekeeper-policy-from-the-console]
== Creating a gatekeeper policy from the console

Install the gatekeeper policy by creating a gatekeeper policy from the console.

After you log into your cluster, navigate to the _Governance_ page.

Select *Create policy*. As you complete the form, select *GatekeeperOperator* from the _Specifications_ field. The parameter values for your policy are automatically populated and the policy is set to `inform` by default. Set your remediation action to `enforce` to install gatekeeper. See https://github.com/stolostron/policy-collection/blob/main/community/CM-Configuration-Management/policy-gatekeeper-operator.yaml[`policy-gatekeeper-operator.yaml`] to view an the sample.
+
*Note:* Consider that default values can be generated by the operator. See https://github.com/open-policy-agent/gatekeeper/blob/master/charts/gatekeeper/README.md[Gatekeeper Helm Chart] for an explanation of the optional parameters that can be used for the gatekeeper operator policy.  

[#gatekeeper-operator-sample]
=== Gatekeeper operator CR

[source,yaml]
----
apiVersion: operator.gatekeeper.sh/v1alpha1
kind: Gatekeeper
metadata:
  name: gatekeeper
spec:
  audit:
    replicas: 1
    logLevel: DEBUG
    auditInterval: 10s
    constraintViolationLimit: 55
    auditFromCache: Enabled
    auditChunkSize: 66
    emitAuditEvents: Enabled
    resources:
      limits:
        cpu: 500m
        memory: 150Mi
      requests:
        cpu: 500m
        memory: 130Mi
  validatingWebhook: Enabled
  webhook:
    replicas: 2
    logLevel: ERROR
    emitAdmissionEvents: Enabled
    failurePolicy: Fail
    resources:
      limits:
        cpu: 480m
        memory: 140Mi
      requests:
        cpu: 400m
        memory: 120Mi
  nodeSelector:
    region: "EMEA"
  affinity:
    podAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchLabels:
              auditKey: "auditValue"
          topologyKey: topology.kubernetes.io/zone
  tolerations:
    - key: "Example"
      operator: "Exists"
      effect: "NoSchedule"
  podAnnotations:
    some-annotation: "this is a test"
    other-annotation: "another test"
----

[#upgrading-gatekeeper-gatekeeper-operator]
== Upgrading gatekeeper and the gatekeeper operator

You can upgrade the versions for gatekeeper and the gatekeeper operator. Complete the following steps:

* When you install the gatekeeper operator with the gatekeeper operator policy, notice the value for `installPlanApproval`. The operator upgrades automatically when `installPlanApproval` is set to `Automatic`. You must approve the upgrade of the gatekeeper operator manually, for each cluster, when `installPlanApproval` is set to `Manual`.

[#updating-gatekeeper-operator-policy]
== Updating gatekeeper operator policy

Learn to update the gatekeeper operator policy by viewing the following section.

[#viewing-gatekeeper-operator-policy-from-the-console]
=== Viewing gatekeeper operator policy from the console

View your gatekeeper operator policy and its status from the console.

After you log into your cluster from the console, click *Governance* to view a table list of your policies. *Note*: You can filter the table list of your policies by selecting the _Policies_ tab or _Cluster violations_ tab.

Select the `policy-gatekeeper-operator` policy to view more details. View the policy violations by selecting the _Clusters_ tab.

[#disabling-gatekeeper-operator-policy]
=== Disabling gatekeeper operator policy

Disable your gatekeeper operator policy.

After you log into your {product-title} console, navigate to the _Governance_ page to view a table list of your policies.

Select the *Actions* icon for the `policy-gatekeeper-operator` policy, then click *Disable*. The _Disable Policy_ dialog box appears.

Click *Disable policy*. Your `policy-gatekeeper-operator` policy is disabled.

[#deleting-gatekeeper-operator-policy]
== Deleting gatekeeper operator policy

Delete the gatekeeper operator policy from the CLI or the console.

* Delete gatekeeper operator policy from the CLI:
 .. Delete gatekeeper operator policy by running the following command:
+
----
kubectl delete policy <policy-gatekeeper-operator-name> -n <namespace>
----
+
After your policy is deleted, it is removed from your target cluster or clusters.

 .. Verify that your policy is removed by running the following command:
+
----
kubectl get policy <policy-gatekeeper-operator-name> -n <namespace>
----

* Delete gatekeeper operator policy from the console:
+
Navigate to the _Governance_ page to view a table list of your policies.
+
Similar to the previous console instructions, click the *Actions* icon for the `policy-gatekeeper-operator` policy. Click *Remove* to delete the policy. From the _Remove policy_ dialog box, click *Remove policy*.

Your gatekeeper operator policy is deleted.

[#uninstalling-gatekeeper]
== Uninstalling gatekeeper policy, gatekeeper, and gatekeeper operator policy

Complete the following steps to uninstall gatekeeper policy, gatekeeper, and gatekeeper operator policy:

. Remove the gatekeeper `Constraint` and `ConstraintTemplate` that is applied on your managed cluster:
.. Edit your gatekeeper operator policy. Locate the `ConfigurationPolicy` template that you used to create the gatekeeper `Constraint` and `ConstraintTemplate`.
.. Change the value for `complianceType` of the `ConfigurationPolicy` template to `mustnothave`.
.. Save and apply the policy.

. Remove gatekeeper instance from your managed cluster:
.. Edit your gatekeeper operator policy. Locate the `ConfigurationPolicy` template that you used to create the Gatekeeper custom resource (CR).
.. Change the value for `complianceType` of the `ConfigurationPolicy` template to `mustnothave`.

. Remove the gatekeeper operator that is on your managed cluster:
.. Edit your gatekeeper operator policy. Locate the `ConfigurationPolicy` template that you used to create the Subscription CR.
.. Change the value for `complianceType` of the `ConfigurationPolicy` template to `mustnothave`.

Gatekeeper policy, gatekeeper, and gatekeeper operator policy are uninstalled.

See xref:../governance/gatekeeper_policy.adoc#gatekeeper-policy[Integrating gatekeeper constraints and constraint templates] for details about gatekeeper. For a list of topics to integrate third-party policies with the product, see xref:../governance/third_party_policy.adoc#integrate-third-party-policy-controllers[Integrate third-party policy controllers]. 

