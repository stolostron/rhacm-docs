[#managing-gatekeeper-operator-policies]
= Managing Gatekeeper operator policies

Use the Gatekeeper operator policy to install the Gatekeeper operator and Gatekeeper on a managed cluster. Learn to create, view, and update your Gatekeeper operator policies in the following sections.

*Required access*: Cluster administrator

- <<install-gatekeeper-operator-policy,Installing Gatekeeper using a Gatekeeper operator policy>>
- <<creating-a-gatekeeper-policy-from-the-console,Creating a Gatekeeper policy from the console>>
- <<upgrading-gatekeeper-gatekeeper-operator,Upgrading Gatekeeper and the Gatekeeper operator>>
- <<updating-gatekeeper-operator-policy,Updating Gatekeeper operator policy>>
- <<deleting-gatekeeper-operator-policy,Deleting Gatekeeper operator policy>>
- <<uninstalling-gatekeeper,Uninstalling Gatekeeper policy, Gatekeeper, and Gatekeeper operator policy>>

[#install-gatekeeper-operator-policy]
== Installing Gatekeeper using a Gatekeeper operator policy

Use the governance framework to install the Gatekeeper operator. Gatekeeper operator is available in the {ocp-short} catalog. See _Adding Operators to a cluster_ in the link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.12/html/operators/administrator-tasks#olm-adding-operators-to-a-cluster[{ocp-short} documentation] for more information.

Use the configuration policy controller to install the Gatekeeper operator policy. During the install, the operator group and subscription pull the Gatekeeper operator to install it in your managed cluster. Then, the Gatekeeper operator creates a Gatekeeper custom resource to configure Gatekeeper. View the <<gatekeeper-operator-sample,Gatekeeper operator custom resource>> sample.

Gatekeeper operator policy is monitored by the {product-title-short} configuration policy controller, where `enforce` remediation action is supported. Gatekeeper operator policies are created automatically by the controller when set to `enforce`.

[#creating-a-gatekeeper-policy-from-the-console]
== Creating a Gatekeeper policy from the console

See the following procedure to create the policy from the console:

. Install the Gatekeeper policy by creating a policy from the console. Alternatively, you can navigate to the _Additional resources_ section for a reference to the sample YAML to deploy `policy-gatekeeper-operator.yaml`.

. After you log in to your cluster, navigate to the _Governance_ page.

. Select *Create policy*. 

. As you complete the form, select *Gatekeeper Operator* from the _Specifications_ field. The parameter values for your policy are automatically populated and the policy is set to `inform` by default. 

. Set your remediation action to `enforce` to install Gatekeeper.

*Note:* Default values are generated by the operator.

[#gatekeeper-operator-sample]
=== Gatekeeper operator custom resource

[source,yaml]
----
apiVersion: operator.gatekeeper.sh/v1alpha1
kind: Gatekeeper
metadata:
  name: gatekeeper
spec:
  audit:
    replicas: 1
    logLevel: DEBUG
    auditInterval: 10s
    constraintViolationLimit: 55
    auditFromCache: Enabled
    auditChunkSize: 66
    emitAuditEvents: Enabled
    resources:
      limits:
        cpu: 500m
        memory: 150Mi
      requests:
        cpu: 500m
        memory: 130Mi
  validatingWebhook: Enabled
  webhook:
    replicas: 3
    emitAdmissionEvents: Enabled
    admissionEventsInvolvedNamespace: Enabled 
    disabledBuiltins: - http.send
    operations:
     - "CREATE"
     - "UPDATE"
     - "CONNECT"
    failurePolicy: Fail
    resources:
      limits:
        cpu: 480m
        memory: 140Mi
      requests:
        cpu: 400m
        memory: 120Mi
  nodeSelector:
    region: "EMEA"
  affinity:
    podAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchLabels:
              auditKey: "auditValue"
          topologyKey: topology.kubernetes.io/zone
  tolerations:
    - key: "Example"
      operator: "Exists"
      effect: "NoSchedule"
  podAnnotations:
    some-annotation: "this is a test"
    other-annotation: "another test"
----
+
You can use the following values to manage your webhook operations. Use the following values for the `operations` parameter, `"CREATE"`, `"UPDATE"`, `"CONNECT"`, and `"DELETE"`.

[#gatekeeper-audit-sync]
=== Configuring _auditFromCache_ for sync details

The Gatekeeper operator exposes a setting in the custom resource definition within the `auditFromCache` audit, which is disabled by default. If you enable `auditFromCache`, then you need to set `config.gatekeeper.sh` for the sync details. See link:https://open-policy-agent.github.io/gatekeeper/website/docs/audit/#configuring-audit[Configuring Audit] in the Gatekeeper documentation.

The Gatekeeper operator collects resources from constraints that users install and then inserts those resources into the config resource. If resources do not exist, the operator creates config resources.

. Set `auditFromCache` to `Automatic` in the `Gatekeeper` resource, as displayed in the following example:

+
[source,yaml]
----
apiVersion: operator.gatekeeper.sh/v1alpha1
kind: Gatekeeper 
metadata: 
  name: gatekeeper 
spec: 
  audit: replicas: 2 
    logLevel: DEBUG 
    auditFromCache: Automatic
----

+
See that the Gatekeeper operator adds `syncOnlys` parameter section to the config file in the following example:

+
[source,yaml]
----
apiVersion: config.gatekeeper.sh/v1alpha1
kind: Config
metadata:
 name: config
 namespace: "openshift-gatekeeper-system"
spec:
 sync:
   syncOnly:
   - group: ""
     version: "v1"
     kind: "Namespace"
   - group: ""
     version: "v1"
     kind: "Pod"
----

. Get the explanation of the `sync` setting, run the following command from your terminal:

+
[source,bash]
----
oc explain gatekeeper.spec.audit.auditFromCache
----

[#upgrading-gatekeeper-gatekeeper-operator]
== Upgrading Gatekeeper and the Gatekeeper operator

You can upgrade the versions for Gatekeeper and the Gatekeeper operator. When you install the Gatekeeper operator with the Gatekeeper operator policy, notice the value for `installPlanApproval`. The operator upgrades automatically when `installPlanApproval` is set to `Automatic`. 

You must approve the upgrade of the Gatekeeper operator manually, for each cluster, when `installPlanApproval` is set to `Manual`.

[#updating-gatekeeper-operator-policy]
== Updating Gatekeeper operator policy

Learn to update the Gatekeeper operator policy by viewing the following section.

[#viewing-gatekeeper-operator-policy-from-the-console]
=== Viewing Gatekeeper operator policy from the console

View your Gatekeeper operator policy and the status from the console.

After you log in to your cluster from the console, click *Governance* to view a table list of your policies. *Note:* You can filter the table list of your policies by selecting the _Policies_ tab or _Cluster violations_ tab.

Select the `policy-gatekeeper-operator` policy to view more details. View the policy violations by selecting the _Clusters_ tab.

[#disabling-gatekeeper-operator-policy]
=== Disabling Gatekeeper operator policy

Disable your gatekeeper operator policy.

After you log in to your {product-title} console, navigate to the _Governance_ page to view a table list of your policies.

Select the *Actions* icon for the `policy-gatekeeper-operator` policy, then click *Disable*. The _Disable Policy_ dialog box appears.

Click *Disable policy*. Your `policy-gatekeeper-operator` policy is disabled.

[#deleting-gatekeeper-operator-policy]
== Deleting Gatekeeper operator policy

Delete the Gatekeeper operator policy from the CLI or the console.

* Delete Gatekeeper operator policy from the CLI:
 .. Delete Gatekeeper operator policy by running the following command:
+
----
oc delete policies.policy.open-cluster-management.io <policy-gatekeeper-operator-name> -n <namespace>
----
+
After your policy is deleted, it is removed from your target cluster or clusters.

 .. Verify that your policy is removed by running the following command:
+
----
oc get policies.policy.open-cluster-management.io <policy-gatekeeper-operator-name> -n <namespace>
----

* Delete Gatekeeper operator policy from the console:
+
Navigate to the _Governance_ page to view a table list of your policies.
+
Similar to the previous console instructions, click the *Actions* icon for the `policy-gatekeeper-operator` policy. Click *Remove* to delete the policy. From the _Remove policy_ dialog box, click *Remove policy*.

Your Gatekeeper operator policy is deleted.

[#uninstalling-gatekeeper]
== Uninstalling Gatekeeper policy, Gatekeeper, and Gatekeeper operator policy

Complete the following steps to uninstall Gatekeeper policy, Gatekeeper, and Gatekeeper operator policy:

. Remove the Gatekeeper `Constraint` and `ConstraintTemplate` that is applied on your managed cluster:
.. Edit your Gatekeeper operator policy. Locate the `ConfigurationPolicy` template that you used to create the Gatekeeper `Constraint` and `ConstraintTemplate`.
.. Change the value for `complianceType` of the `ConfigurationPolicy` template to `mustnothave`.
.. Save and apply the policy.

. Remove Gatekeeper instance from your managed cluster:
.. Edit your Gatekeeper operator policy. Locate the `ConfigurationPolicy` template that you used to create the Gatekeeper custom resource.
.. Change the value for `complianceType` of the `ConfigurationPolicy` template to `mustnothave`.

. Remove the Gatekeeper operator that is on your managed cluster:
.. Edit your Gatekeeper operator policy. Locate the `ConfigurationPolicy` template that you used to create the Subscription CR.
.. Change the value for `complianceType` of the `ConfigurationPolicy` template to `mustnothave`.

Gatekeeper policy, Gatekeeper, and Gatekeeper operator policy are uninstalled.

[#additional-resources-gk-operator]
== Additional resources

- See xref:../governance/gatekeeper_policy.adoc#gatekeeper-policy[Integrating Gatekeeper constraints and constraint templates] for details about Gatekeeper.

- See the link:https://github.com/open-cluster-management-io/policy-collection/blob/main/stable/CM-Configuration-Management/policy-gatekeeper-operator-downstream.yaml[Policy Gatekeeper] sample.

- See link:https://github.com/open-policy-agent/gatekeeper/blob/master/charts/gatekeeper/README.md[Gatekeeper Helm Chart] for an explanation of the optional parameters that can be used for the Gatekeeper operator policy.

- For a list of topics to integrate third-party policies with the product, see xref:../governance/third_party_policy_intro.adoc#integrate-third-party-policy-controllers[Integrate third-party policy controllers]. 

