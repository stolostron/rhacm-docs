[#kubernetes-configuration-policy-controller]
= Kubernetes configuration policy controller

Configuration policy controller can be used to configure any Kubernetes resource and apply security policies across your clusters. The configuration policy is provided in the `policy-templates` field of the policy on the hub and is propagated to the selected managed clusters by the governance framework. See the xref:../governance/policy_example.adoc#policy-yaml-structure[policy YAML documentation] for more about the hub policy.

The configuration policy controller communicates with the local Kubernetes API server to get the list of your configurations that are in your cluster. For more information about CRDs, see https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/[Extend the Kubernetes API with CustomResourceDefinitions].

The configuration policy controller is created on the managed cluster during installation. Configuration policy controller supports the `enforce` feature to remediate when the configuration policy becomes NonCompliant. View the following sample configuration policies:

|===
| Policy sample | Description

| https://github.com/stolostron/policy-collection/blob/main/stable/CM-Configuration-Management/policy-namespace.yaml[Namespace policy]
| Ensure consistent environment isolation and naming with Namespaces. See the Kubernetes
https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/[Namespace documentation].

| https://github.com/stolostron/policy-collection/blob/main/stable/CM-Configuration-Management/policy-pod.yaml[Pod policy]
| Ensure cluster workload configuration. See the Kubernetes https://kubernetes.io/docs/concepts/workloads/pods/[Pod documentation].

| https://github.com/stolostron/policy-collection/blob/main/stable/SC-System-and-Communications-Protection/policy-limitmemory.yaml[Memory usage policy]
| Limit workload resource usage using Limit Ranges. See the
https://kubernetes.io/docs/concepts/policy/limit-range/[Limit Range documentation].

| (_Deprecated_) https://github.com/stolostron/policy-collection/blob/main/stable/SC-System-and-Communications-Protection/policy-psp.yaml[Pod security policy]
| Ensure consistent workload security. See the Kubernetes
https://kubernetes.io/docs/concepts/policy/pod-security-policy/[Pod Security Policy documentation].

| https://github.com/stolostron/policy-collection/blob/main/stable/AC-Access-Control/policy-role.yaml[Role policy] +
https://github.com/stolostron/policy-collection/blob/main/stable/AC-Access-Control/policy-rolebinding.yaml[Role binding policy]
| Manage role permissions and bindings using Roles and Role Bindings. See the Kubernetes https://kubernetes.io/docs/reference/access-authn-authz/rbac/[RBAC documentation].

| https://github.com/stolostron/policy-collection/blob/main/stable/SC-System-and-Communications-Protection/policy-scc.yaml[Security content constraints (SCC) policy]
| Manage workload permissions with Security Context Constraints. See the Openshift https://docs.openshift.com/container-platform/4.10/authentication/managing-security-context-constraints.html[Security Context Constraints documentation].

| https://github.com/stolostron/policy-collection/blob/main/stable/SC-System-and-Communications-Protection/policy-etcdencryption.yaml[ETCD encryption policy]
| Ensure data security with etcd encryption. See the Openshift https://docs.openshift.com/container-platform/4.10/security/encrypting-etcd.html[etcd encryption documentation].

| https://github.com/stolostron/policy-collection/blob/main/stable/CA-Security-Assessment-and-Authorization/policy-compliance-operator-install.yaml[Compliance operator policy]
| Deploy the Compliance Operator to scan and enforce the compliance state of clusters leveraging OpenSCAP. See the Openshift https://docs.openshift.com/container-platform/4.11/security/compliance_operator/compliance-operator-understanding.html[Compliance Operator documentation].

| https://github.com/stolostron/policy-collection/blob/main/stable/CM-Configuration-Management/policy-compliance-operator-e8-scan.yaml[Compliance operator E8 scan]
| After applying the Compliance operator policy, deploy an Essential 8 (E8) scan to check for compliance with E8 security profiles. See the Openshift https://docs.openshift.com/container-platform/4.11/security/compliance_operator/compliance-operator-understanding.html[Compliance Operator documentation].

| https://github.com/stolostron/policy-collection/blob/main/stable/CM-Configuration-Management/policy-compliance-operator-cis-scan.yaml[Compliance operator CIS scan]
| After applying the Compliance operator policy, deploy a Center for Internet Security (CIS) scan to check for compliance with CIS security profiles. See the Openshift https://docs.openshift.com/container-platform/4.11/security/compliance_operator/compliance-operator-understanding.html[Compliance Operator documentation].

| https://github.com/stolostron/policy-collection/blob/main/stable/SI-System-and-Information-Integrity/policy-imagemanifestvuln.yaml[Image vulnerability policy]
| Deploy the Container Security Operator and detect known image vulnerabilities in pods running on the cluster. See the https://github.com/quay/container-security-operator#readme[Container Security Operator GitHub].

| xref:../governance/gatekeeper_policy.adoc#create-gatekeeper[Gatekeeper operator deployment]
| Gatekeeper is an admission webhook that enforces custom resource definition (CRD)-based policies executed by the Open Policy Agent (OPA) policy engine. See the https://open-policy-agent.github.io/gatekeeper/website/docs/[Gatekeeper] documentation.

| xref:../governance/gatekeeper_policy.adoc#gatekeeper-policy[Gatekeeper compliance policy]
| After deploying Gatekeeper to the clusters, deploy this sample Gatekeeper policy that ensures namespaces that are created on the cluster are labeled as specified.

|===

When the `remediationAction` for the configuration policy is set to `enforce`, the controller applies the specified configuration to the target managed cluster. You can also use templated values inside of configuration policies. For more information, see xref:../governance/custom_template.adoc#support-templates-in-config-policies[Support for templates in configuration policies].

Continue reading to learn more about the configuration policy controller: 

* <<configuration-policy-sample,Configuration policy sample>>
* <<configuration-policy-yaml-table,Configuration policy YAML table>>

[#configuration-policy-sample]
== Configuration policy sample

[source,yaml]
----
apiVersion: policy.open-cluster-management.io/v1
kind: ConfigurationPolicy
metadata:
  name: policy-config
spec:
  namespaceSelector:
    include: ["default"]
    exclude: []
    matchExpressions: []
    matchLabels: {}
  remediationAction: inform
  severity: low
  object-templates:
  - complianceType: musthave
    objectDefinition:
      apiVersion: v1
      kind: Pod
      metadata:
        name: pod
      spec:
        containers:
        - image: pod-image
          name: pod-name
          ports:
          - containerPort: 80
  evaluationInterval:
    compliant:
    noncompliant:
----

[#configuration-policy-yaml-table]
== Configuration policy YAML table

.Parameter table
|===
| Field | Description

| apiVersion
| Required.
Set the value to `policy.open-cluster-management.io/v1`.

| kind
| Required.
Set the value to `ConfigurationPolicy` to indicate the type of policy.

| metadata.name
| Required. The name of the policy.

| spec.namespaceSelector
| Required for namespaced objects that do not have a namespace specified. Determines namespaces in the managed cluster that the object is applied to. The `include` and `exclude` parameters accept filepath expressions to include and exclude namespaces by name. The `matchExpressions` and `matchLabels` parameters specify namespaces to include by label. (See the https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/[Kubernetes labels and selectors] documentation.) The resulting list is compiled by ANDing results from all parameters.

| spec.remediationAction
| Required. Specifies the action to take when the policy becomes NonCompliant. Use the following parameter values: `inform` or `enforce`.

| spec.severity
| Required. Specifies the severity when the policy is non-compliant. Use the following parameter values: `low`, `medium`, or `high`.

| spec.object-templates[].objectDefinition
| Required. The object definition for the controller to use to validate objects on the managed cluster.

| spec.object-templates[].complianceType
| Required. Behavior for Kubernetes objects that must be evaluated or applied to the managed clusters. You must use the following verbs as parameter values:

`mustonlyhave`: Indicates that an object must exist with the exact fields and values as defined in the object.

`musthave`: Indicates an object must exist with the same fields as specified in the objectDefinition. The fields in the template are a subset of what exists in the object. Array values are appended.

`mustnothave`: Indicates that an object with the same fields as specified in the objectDefinition cannot exist.

| spec.evaluationInterval.compliant
| Optional. Used to define how often the policy is evaluated when it is in the compliant state. The values must be in the format of a duration which is a sequence of numbers with time unit suffixes. For example, `12h30m5s` represents 12 hours, 30 minutes, and 5 seconds. It can also be set to `never` so that the policy is not reevaluated on the compliant cluster, unless the policy `spec` is updated.

| spec.evaluationInterval.noncompliant
| Optional. Used to define how often the policy is evaluated when it is in the non-compliant state. Similar to the `evaluationInterval.compliant` parameter, the values must be in the format of a duration which is a sequence of numbers with time unit suffixes. It can also be set to `never` so that the policy is not reevaluated on the noncompliant cluster, unless the policy `spec` is updated.
|===

See the policy samples that use https://nvd.nist.gov/800-53/Rev4/control/CA-1[NIST Special Publication 800-53 (Rev. 4)], and are supported by {product-title-short} from the https://github.com/stolostron/policy-collection/tree/main/stable/CM-Configuration-Management[`CM-Configuration-Management` folder]. Learn about how policies are applied on your hub cluster, see xref:../governance/policy_sample_intro.adoc#supported-policies[Supported policies] for more details. 

Learn how to create and customize policies, see xref:../governance/manage_policy_overview.adoc#manage-security-policies[Manage security policies]. Refer to xref:../governance/policy_controllers.adoc#policy-controllers[Policy controllers] for more details about controllers.

[#configuration-config-policy-controller]
== Configuring the configuration policy controller

You can configure the concurrency of the configuration policy controller per managed cluster to change how many configuration policies it can evaluate at the same time. To change the default value of `2`, set the `policy-evaluation-concurrency` annotation with a non-zero integer within quotes. You can set the value on the `ManagedClusterAddOn` object called `config-policy-controller` in the managed cluster namespace of the hub.

*Note*: Higher concurrency values increase CPU and memory utilization on the `config-policy-controller` pod, Kubernetes API server, and OpenShift API server.

In the following YAML example, concurrency is set to `5` on the managed cluster called `cluster1`:

[source,yaml]
----
apiVersion: addon.open-cluster-management.io/v1alpha1
kind: ManagedClusterAddOn
metadata:
  name: config-policy-controller
  namespace: cluster1
  annotations:
    policy-evaluation-concurrency: "5"
spec:
  installNamespace: open-cluster-management-agent-addon
----
