[#policy-generator]
= Policy generator

Policy generator is a part of the {product-title} application lifecycle link:../applications/subscription_sample.adoc#applying-kustomize[`Subscription`] that generates {product-title} policies through GitOps using Kustomize. The policy generator builds {product-title} policies from Kubernetes manifest YAML files, which are provided through a `PolicyGenerator` manifest YAML file that is used to configure it. The policy generator is implemented as a Kustomize generator plugin. For more information on Kustomize, see the link:https://kustomize.io/[Kustomize documentation].

[#policy-generator-components]
== Policy generator components

The policy generator requires a Kustomize plugin, a `Placement` resource, and policy expanders. View the following descriptions of the policy generator components:

* *Kustomize plugin*: The policy generator plugin is a binary written in Go language. The binary accepts an input manifest of the `PolicyGenerator` kind in the `policy.open-cluster-management.io/v1` API. When Kustomize finds a `PolicyGenerator` resources in the `generators:` section of the `kustomization.yaml`, it looks in its directories for a binary of the same name (`PolicyGenerator`) in the `policy.open-cluster-management.io/vi/policygenerator` directory. Kustomize also calls the binary as `<path>/PolicyGenerator <cached-manifest>` to run the generator as its plugin. The `--enable-alpha-plugins` flag  must be specified in the Kustomize command for the external generator plugin to be enabled.

* *Placement*: By default, a `Placement` and `PlacementBinding` are created for each policy with the policy. If you want to consolidate policies that use the same `Placement` in a single `PlacementBinding`, either specify `placement.placementRulePath` to an existing `Placement` manifest or set `placement.name` along with `placement.clusterSelectors`. When the `PlacementBinding` is consolidated in this way, `placementBindingDefaults.name` must be specified so that the generator can create unique names for the bindings.

* *Policy expanders*: Policy expanders provide logic to create additional policies based on a given kind to the violations or status using {product-title-short} policies. Generally, the expanders point to kinds provided by third-party policy engines such as Kyverno and Gatekeeper. These expanders are enabled by default, but can be disabled individually by setting the flag associated with the expander in the `PolicyGenerator` manifest either in policyDefaults or for a particular manifest in the policies array. If you want to contribute a policy expander, see link:https://github.com/open-cluster-management/policy-generator-plugin/blob/main/docs/policygenerator.md#contributing-a-policy-expander[Contributing a policy expander].
//in the doc, we refer to Gatekeeper as a third-party integration? Wonder of we should link Policy generator doc from the Integrate third-party doc

[#policy-generator-structure]
== Policy generator YAML structure

View the following YAML structure for the explained parameter fields:

[source,yaml]
----
apiVersion: policy.open-cluster-management.io/v1
kind: PolicyGenerator
metadata:
  name: ""
placementBindingDefaults:
  name: ""
policyDefaults:
  categories:
    - "CM Configuration Management"
  controls:
    - "CM-2 Baseline Configuration"
  consolidateManifests: true
  informKyvernoPolicies: true
  namespace: ""
  placement:
    clusterSelectors: {}
    name: ""
    placementRulePath: ""
  remediationAction: "inform"
  severity: "low"
  standards:
    - "NIST SP 800-53"
policies:
  - name: ""
    manifests:
      - path: ""
        # Optional. A Kustomize patch to apply to the manifest(s) at the path. If there
        # are multiple manifests, the patch requires the apiVersion, kind, metadata.name,
        # and metadata.namespace (if applicable) fields to be set so Kustomize
        # can identify the manifest the patch applies to.
        patches:
            # Optional: Only required when there are multiple manifests in the path.
          - apiVersion: ""
            # Optional: Only required when there are multiple manifests in the path.
            kind: ""
            metadata:
              # Optional: Only required when there are multiple manifests in the path.
              name: ""
              # Optional: Only required when there are multiple manifests in the path and it's a
              # manifest to a namespaced resource.
              namespace: ""
              # An example modification to the manifest
              annotations:
                friends-character: Chandler Bing
    # Optional. (See policyDefaults.categories for description.)
    categories:
      - "CM Configuration Management"
    complianceType: "musthave"
    # Optional. (See policyDefaults.controls for description.)
    controls:
      - "CM-2 Baseline Configuration"
    # Optional. (See policyDefaults.disabled for description.)
    disabled: false
    # Optional. (See policyDefaults.informKyvernoPolicies for description.)
    informKyvernoPolicies: true
    # Optional. (See policyDefaults.consolidateManifests for description.)
    consolidateManifests: true
    namespaceSelector:
      include: []
      exclude: []
    # Optional. (See policyDefaults.placement for description.)
    placement: {}
    # Optional. (See policyDefaults.remediationAction for description.)
    remediationAction: ""
    # Optional. (See policyDefaults.severity for description.)
    severity: "low"
    # Optional. (See policyDefaults.standards for description.)
    standards:
      - "NIST SP 800-53"
----

[#policy-gen-yaml-table]
== Policy generator YAML table

|===
| Field | Description

| apiVersion
| Required.
Set the value to `policy.open-cluster-management.io/v1`.

| kind
| Required.
Set the value to `PolicyGenerator` to indicate the type of policy.

| metadata
| Required.
Used to uniquely identify the configuration file.

| metadata.name
| Required.
The name for identifying the policy resource.

| placementBindingDefaults
| Required.
Used to consolidate multiple policies in a `PlacementBinding`, so that the generator can create unique `PlacementBinding` names using the name that is defined.
//what is the default value ? 
| placementBindingDefaults.name
| Optional.
It is best practice to set an explicit placement binding name to use rather than use the default value.

| policyDefaults
| Required.
Any default value listed here is overridden for an entry in the policies array except for `namespace`.

| policyDefaults.categories
| Optional.
Array of categories to be used in the `policy.open-cluster-management.io/categories` annotation. The default value is `CM Configuration Management`.

| policyDefaults.controls
| Optional.
Array of controls to be used in the `policy.open-cluster-management.io/controls` annotation. The default value is `CM-2 Baseline Configuration`.

| policyDefaults.consolidateManifests
| Optional.
This determines if a single configuration policy should be generated for all the manifests being wrapped in the policy. If set to `false`, a configuration policy per manifest is generated. The default value is `true`.

| policyDefaults.informKyvernoPolicies
| Optional.
When the policy references a Kyverno policy manifest, this determines if an additonal configuration policy should be generated to receive policy violations in {product-title-short}, when the Kyverno policy has been violated. The default value is `true`.

| policyDefaults.namespace
| Required.
The namespace of all the policies.

| policyDefaults.placement
| Optional. The placement configuration for the policies. This defaults to a placement configuration that matches all clusters.

| placement.clusterSelectors
| Optional. 
Specify a placement by specifying a cluster selector in the following format, `key:value`. See `placementRulePath` ti specify an existing file.

| placement.name
| Optional. 
Specify a name to consolidate placement rules that contain the same cluster selectors.

| placement.placementRulePath
| Optional. 
To reuse an existing placement rule, specify the path here relative to the `kustomization.yaml` file. If provided, this placement rule is used by all policies by default. See `clusterSelectors` to generate a new `Placement`.

| policyDefaults.remediationAction
| Optional.
The remediation mechanism of your policy. The parameter values are `enforce` and `inform`. The default value is `inform`.

| policyDefaults.severity
| Optional.
The severity of the policy violation. The default value is `low`.

| policyDefaults.standards
| Optional.
An array of standards to be used in the `policy.open-cluster-management.io/standards` annotation. The default value is `NIST SP 800-53`.

| policies
| Required.
The list of policies to create along with overrides to either the default values, or the values that are set in `policyDefaults.`

| policies.name
| Required.
The name of the policy to create.

| policies.manifests
| Required.
The list of Kubernetes object manifests to include in the policy.

| manifests.path
| Optional.
Path to a single file or a flat directory of files relative to the `kustomization.yaml` file.

| manifests.patches
| Optional.
A Kustomize patch to apply to the manifest at the path. If there are multiple manifests, the patch requires the `apiVersion`, `kind`, `metadata.name`, and `metadata.namespace` (if applicable) fields to be set so Kustomize can identify the manifest that the patch applies to.

| complianceType
| Optional.
Determines the policy controller behavior when comparing the manifest to objects on the cluster. The parameter values are `musthave`, `mustonlyhave`, or `mustnothave`. The defaultvalue is `musthave`.
|===

See link:https://github.com/open-cluster-management/policy-generator-plugin/blob/main/docs/policygenerator-reference.yaml[`policygenerator-reference.yaml`] for more details. Learn how to use the policy generator, see xref:../governance/using_policy_generator.adoc#config-policy-generator[Configuring the policy generator].

