[#policy-operator]
= Operator policy controller

The operator policy controller allows you to monitor and install {olm} operators across your clusters. Use the operator policy controller to monitor the health of various pieces of the operator and to specify how you want to automatically handle updates to the operator. 

You can also distribute an operator policy to managed clusters by using the governance framework and adding the policy to the `policy-templates` field of a policy on the hub cluster.

You can also use template values within the `operatorGroup` and `subscription` fields of an operator policy. For more information, see _Template processing_.

[#pre-req-policy-operator]
== Prerequisites

* {olm} must be available on your managed cluster. This is enabled by default on {ocp}.

* *Required access:* Cluster administrator

[#policy-operator-yaml-table]
== Operator policy YAML table

|===
| Field | Optional or required | Description

| `apiVersion`
| Required
| Set the value to `policy.open-cluster-management.io/v1beta1`.

| `kind`
| Required
| Set the value to `OperatorPolicy` to indicate the type of policy.

| `metadata.name`
| Required
| The name for identifying the policy resource.

| `spec.remediationAction`
| Required
| If the `remediationAction` for the operator policy is set to `enforce`, the controller creates resources on the target managed cluster to communicate to OLM to install the operator and approve updates based on the versions specified in the policy.
+
If the `remediationAction` set to `inform`, the controller only reports the status of the operator, including if any upgrades are available.

| `spec.operatorGroup`
| Optional
| By default, if the `operatorGroup` field is not specified, the controller generates an `AllNamespaces` type OperatorGroup in the same namespace as the subscription, if supported. This resource is generated by the operator policy controller.
| `spec.complianceType`
| Required
| Specifies the desired state of the operator on the cluster. If set to `musthave`, the policy is compliant when the operator is found. If set to `mustnothave`, the policy is compliant when the operator is not found.
| `spec.removalBehavior`
| Optional 
a| Determines which resource types need to be kept or removed when you enforce an `OperatorPolicy` resource with `complianceType: mustnothave` defined. There is no effect when `complianceType` is set to `musthave`. 
- `operatorGroups` can be set to `Keep` or `DeleteIfUnused`. The default value is `DeleteIfUnusued` which only removes the `OperatorGroup` resource if it is not used by any other operators.
- `subscriptions` can be set to `Keep` or `Delete`. The default value is `Delete`.
- `clusterServiceVersions` can be set to `Keep` or `Delete`. The default value is `Delete`.
- `customResourceDefinitions` can be set to `Keep` or `Delete`. The default value is `Keep`. If you set this to `Delete`,  the `CustomResourceDefintion` resources on the managed cluster are removed and can cause data loss.

| `spec.subscription`
| Required
a| Define the configurations to create an operator subscription. Add information in the following fields to create an operator subscription. Default options are selected for a few items if there is no entry:

- `channel`: If not specified, the default channel is selected from the operator catalog. The default can be different on different {ocp-short} versions.
- `name`: Specify the package name of the operator.
- `namespace`: If not specified, the default namespaced that is used for {ocp-short} managed clusters is `openshift-operators`.
- `source`: If not specified, the catalog that contains the operator is chosen.
- `sourceNamespace`: If not specified, the namespace of the catalog that contains the operator is chosen.
+
*Note:* If you define a value for `upgradeApproval`, your policy becomes non-compliant.

| `spec.complianceConfig`
| Optional
a| Use this parameter to define the compliance behavior for specific scenarios that are associated with operators. You can set each of the following options individually, where the supported values are `Compliant` and `NonCompliant`:

- `catalogSourceUnhealthy`: Define the compliance when the catalog source for the operator is unhealthy. The default value is `Compliant` because this only affects possible upgrades.
- `deploymentsUnavailable`: Define the compliance when at least one deployment of the operator is not fully available. The default value is `NonCompliant` because this reflects the availability of the service that the operator provides.
- `upgradesAvailable`: Define the compliance when there is an upgrade available for the operator. The default value is `Compliant` because the existing operator installation might be running correctly.

| `spec.upgradeApproval`
| Required
| If the `upgradeApproval` field is set to `Automatic`, version upgrades on the cluster are approved by the policy when the policy is set to `enforce`. If you set the field to `None`, version upgrades to the specific operator are not approved when the policy is set to `enforce`.

| `spec.versions`
| Optional
| Declare which versions of the operator are compliant. If the field is empty, any version running on the cluster is considered compliant. If the field is not empty, the version on the managed cluster must match one of the versions in the list for the policy to be compliant. If the policy is set to `enforce` and the list is not empty, the versions listed here are approved by the controller on the cluster.
|===

[#policy-operator-add-res]
== Additional resources

* See xref:../governance/template_support_intro.adoc#template-processing[Template processing].
* See xref:../governance/install_operator.adoc#install-operator-with-policy[Installing an operator by using the `OperatorPolicy` resource] for more details.
* See the link:https://docs.redhat.com/documentation/en-us/openshift_container_platform/4.14/html/operators/understanding-operators#olm-subscription_olm-understanding-olm[Subscription] topic in the {ocp-short} documentation.
* See link:https://docs.redhat.com/documentation/en-us/openshift_container_platform/4.14/html/operators/understanding-operators#operator-lifecycle-manager-olm[Operator Lifecycle Manager (OLM)] for more details.
* See the link:https://docs.redhat.com/documentation/en-us/openshift_container_platform/4.14/html-single/operators/index#olm-adding-operators-to-a-cluster[Adding Operators to a cluster] documentation for general information on OLM.
