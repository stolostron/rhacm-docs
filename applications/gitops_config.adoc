
[#gitops-config]
= Configuring Managed Clusters for OpenShift GitOps operator and Argo CD

To configure GitOps, you can register a set of one or more {product-title} managed clusters to an instance of Argo CD or {ocp} GitOps operator. After registering,  you can deploy applications to those clusters. Set up a continuous GitOps environment to automate application consistency across clusters in development, staging, and production environments.

[#prerequisites-argo]
== Prerequisites 

. You need to https://argo-cd.readthedocs.io/en/stable/getting_started/#1-install-argo-cd[Install Argo CD] or the https://access.redhat.com/documentation/en-us/openshift_container_platform/4.9/html/cicd/gitops[Red Hat OpenShift GitOps operator] on your {product-title}.

. Import one or more managed clusters.

[#register-gitops]
== Registering managed clusters to GitOps

. Create managed cluster sets and add managed clusters to those managed cluster sets. See the example for managed cluster sets in the https://github.com/open-cluster-management/multicloud-integrations/blob/main/examples/managedclusterset.yaml[multicloud-integrations managedclusterset]. Use this example to create your managed cluster set.

+
See the link:../clusters/managedclustersets.adoc#managedclustersets[Creating and managing ManagedClusterSets] documentation for more information.

. Create managed cluster set _binding_ to the namespace where Argo is deployed. Bind to the `openshift-gitops` or `argoNamespace` specification. Use the example in the repository at https://github.com/open-cluster-management/multicloud-integrations/blob/main/examples/gitopscluster.yaml[multicloud-integrations gitops cluster].

. In the namespace that is used in managed cluster set binding, create a _Placement_ to select managed clusters from the managed cluster set. See the example in the repository at https://github.com/open-cluster-management/multicloud-integrations/blob/main/examples/placement.yaml[multicloud-integration placement].

+
See link:../clusters/placement_managed.adoc#placement-managed[Using ManagedClustersSets with Placement] for placement information. 

. Create a placement custom resource to select a set of managed clusters to register to an ArgoCD or {ocp-short} GitOps operator instance. You can use the example in the repository at https://github.com/open-cluster-management/multicloud-integrations/blob/main/examples/managedclustersetbinding.yaml[multicloud-integrations managedclustersetbinding].

+
*Note:* Only {ocp-short} clusters are registered to an ArgoCD or OpenShift GitOps operator instance, not other Kubernetes clusters.

. Bind a `Placement` to the cluster with a `GitOpsCluster` custom resource, which registers the set of managed clusters from the placement decision to the specified instance of Argo CD or {ocp} GitOps operator. This enables the ArgoCD instance to deploy applications to any of those {product-title-short} managed clusters. 

+
*Note:* The referenced `Placement` resource must be in the same namespace as the `GitOpsCluster` resource.

+
See from the following sample that `placementRef:name` is `development-clusters`, and is specified as target clusters for the GitOps instance that is installed in `argoNamespace:openshift-gitops`. The `argoServer.cluster` specification requires the `local-cluster` value.

+
[source,yaml]
----
apiVersion: apps.open-cluster-management.io/v1alpha1
kind: GitOpsCluster
metadata:
  name: gitops-cluster-sample
  namespace: dev
spec:
  argoServer:
    cluster: local-cluster
    argoNamespace: openshift-gitops
  placementRef:
    kind: Placement
    apiVersion: cluster.open-cluster-management.io/v1alpha1
    name: all-openshift-clusters
----

. Save your changes. You can now follow the GitOps workflow to manage your applications. See link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.9/html-single/cicd/index#understanding-openshift-gitops[About GitOps] to learn more.
